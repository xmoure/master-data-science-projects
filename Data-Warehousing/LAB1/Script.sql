
--------------------- Tables ---------------------

CREATE TABLE "DT_TIME_DAY"
(
  "ID_DAY" NUMBER (9),
  "T_DAY" NUMBER (4) NOT NULL,
  "ID_MONTH" NUMBER (9)
);
ALTER TABLE "DT_TIME_DAY" ADD CONSTRAINT "PK_DT_TIME_DAY" PRIMARY KEY ("ID_DAY");

CREATE TABLE "DT_TIME_MONTH"
(
  "ID_MONTH" NUMBER (9),
  "T_MONTH" NUMBER (4) NOT NULL,
  "ID_YEAR" NUMBER (9)
);
ALTER TABLE "DT_TIME_MONTH" ADD CONSTRAINT "PK_DT_TIME_MONTH" PRIMARY KEY ("ID_MONTH");

CREATE TABLE "DT_TIME_YEAR"
(
  "ID_YEAR" NUMBER (9),
  "T_YEAR" CHAR(4)  NOT NULL
);
ALTER TABLE "DT_TIME_YEAR" ADD CONSTRAINT "PK_DT_TIME_YEAR" PRIMARY KEY ("ID_YEAR");

ALTER TABLE "DT_TIME_DAY" ADD CONSTRAINT "FK_DT_TIME_DAY" FOREIGN KEY ("ID_MONTH") REFERENCES "DT_TIME_MONTH"("ID_MONTH") ;

ALTER TABLE "DT_TIME_MONTH" ADD CONSTRAINT "FK_DT_TIME_MONTH" FOREIGN KEY ("ID_YEAR") REFERENCES "DT_TIME_YEAR"("ID_YEAR");


CREATE TABLE "DT_AIRCRAFT"
(
  "REGISTRATION_CODE" VARCHAR2 (255 CHAR),
  "MANUFACTURER_SERIAL_NMBR" VARCHAR2 (255 CHAR) NOT NULL,
  "MANUFACTURER" VARCHAR2 (255 CHAR) NOT NULL,
  "MODEL" VARCHAR2 (255 CHAR) NOT NULL
);
ALTER TABLE "DT_AIRCRAFT" ADD CONSTRAINT "PK_DT_AIRCRAFT" PRIMARY KEY ("REGISTRATION_CODE");


CREATE TABLE "DT_PERSONNEL"
(
  "ID_REPORTEUR" NUMBER (9),
  "PERSON_ROLE" CHAR(1) CHECK ("PERSON_ROLE" IN ('P','M')) NOT NULL,
  "AIRPORT" VARCHAR2 (255 CHAR) NOT NULL
);
ALTER TABLE "DT_PERSONNEL" ADD CONSTRAINT "PK_DT_PERSONNEL" PRIMARY KEY ("ID_REPORTEUR");


CREATE TABLE "AIRCRAFT_METRICS"
(
  "ID_DAY" NUMBER (9),
  "REGISTRATION_CODE" VARCHAR2 (255 CHAR),
  "TAKE_OFF_TO" NUMBER (18,3) NOT NULL,
  "FLIGHT_HOURS_FH" NUMBER (18,3) NOT NULL,
  "DELAY_QUANTITY" NUMBER (18,3) NOT NULL,
  "NUMBER_OF_CANCELLATIONS" NUMBER (18,3) NOT NULL,
  "DAYS_IN_SERVICE_ADIS" NUMBER (18,3) NOT NULL,
  "DELAY_DURATION" NUMBER (18,3) NOT NULL,
  "DAYS_OUT_OF_SERVICE_S" NUMBER (18,3) NOT NULL,
  "DAYS_OUT_OF_SERVICE_U" NUMBER (18,3) NOT NULL
);
ALTER TABLE "AIRCRAFT_METRICS" ADD CONSTRAINT "PK_AIRCRAFT_METRICS" PRIMARY KEY ("ID_DAY", "REGISTRATION_CODE");
ALTER TABLE "AIRCRAFT_METRICS" ADD CONSTRAINT "FK_AIRCRAFT_METRICS_ID_DAY" FOREIGN KEY ("ID_DAY") REFERENCES "DT_TIME_DAY" ("ID_DAY");
ALTER TABLE "AIRCRAFT_METRICS" ADD CONSTRAINT "FK_FT_FLGH_ID_REGISTRATION" FOREIGN KEY ("REGISTRATION_CODE") REFERENCES "DT_AIRCRAFT" ("REGISTRATION_CODE");


CREATE TABLE "FT_LOGS"
(
  "ID_MONTH" NUMBER (9),
  "REGISTRATION_CODE" VARCHAR2 (255 CHAR),
  "ID_REPORTEUR" NUMBER (9),
  "LOGBOOK_COUNT" NUMBER (18,3) NOT NULL
);
ALTER TABLE "FT_LOGS" ADD CONSTRAINT "PK_FT_LOGS" PRIMARY KEY ("ID_MONTH", "REGISTRATION_CODE", "ID_REPORTEUR");
ALTER TABLE "FT_LOGS" ADD CONSTRAINT "FK_FT_LOGS_ID_REGISTRTION" FOREIGN KEY ("REGISTRATION_CODE") REFERENCES "DT_AIRCRAFT" ("REGISTRATION_CODE");
ALTER TABLE "FT_LOGS" ADD CONSTRAINT "FK_FT_LOGS_ID_REPORTEUR" FOREIGN KEY ("ID_REPORTEUR") REFERENCES "DT_PERSONNEL" ("ID_REPORTEUR");


-------------------------------- INSERTS --------------------------------------------

/*
INSERT INTO "DT_TIME_YEAR" VALUES (1,2010);
INSERT INTO "DT_TIME_YEAR" VALUES (2,2011);
INSERT INTO "DT_TIME_YEAR" VALUES (3,2012);
INSERT INTO "DT_TIME_YEAR" VALUES (4,2013);
INSERT INTO "DT_TIME_YEAR" VALUES (5,2014);
INSERT INTO "DT_TIME_YEAR" VALUES (6,2015);
INSERT INTO "DT_TIME_YEAR" VALUES (7,2016);
INSERT INTO "DT_TIME_YEAR" VALUES (8,2017);
INSERT INTO "DT_TIME_YEAR" VALUES (9,2018);
INSERT INTO "DT_TIME_YEAR" VALUES (10,2019);
INSERT INTO "DT_TIME_YEAR" VALUES (11,2020);
INSERT INTO "DT_TIME_YEAR" VALUES (12,2021);
INSERT INTO "DT_TIME_YEAR" VALUES (13,2022);

INSERT INTO "DT_TIME_MONTH" VALUES (1,01,1);
INSERT INTO "DT_TIME_MONTH" VALUES (2,02,2);
INSERT INTO "DT_TIME_MONTH" VALUES (3,03,3);
INSERT INTO "DT_TIME_MONTH" VALUES (4,04,4);
INSERT INTO "DT_TIME_MONTH" VALUES (5,05,5);
INSERT INTO "DT_TIME_MONTH" VALUES (6,06,6);
INSERT INTO "DT_TIME_MONTH" VALUES (7,07,7);
INSERT INTO "DT_TIME_MONTH" VALUES (8,08,8);
INSERT INTO "DT_TIME_MONTH" VALUES (9,09,9);
INSERT INTO "DT_TIME_MONTH" VALUES (10,10,10);
INSERT INTO "DT_TIME_MONTH" VALUES (11,11,11);
INSERT INTO "DT_TIME_MONTH" VALUES (12,12,12);

INSERT INTO "DT_TIME_DAY" VALUES (1,01,1);
INSERT INTO "DT_TIME_DAY" VALUES (2,02,2);
INSERT INTO "DT_TIME_DAY" VALUES (3,03,3);
INSERT INTO "DT_TIME_DAY" VALUES (4,04,4);
INSERT INTO "DT_TIME_DAY" VALUES (5,05,5);
INSERT INTO "DT_TIME_DAY" VALUES (6,06,6);
INSERT INTO "DT_TIME_DAY" VALUES (7,07,7);
INSERT INTO "DT_TIME_DAY" VALUES (8,08,8);
INSERT INTO "DT_TIME_DAY" VALUES (9,09,9);
INSERT INTO "DT_TIME_DAY" VALUES (10,10,10);


INSERT INTO "DT_AIRCRAFT" VALUES ('XY-ALV','Bow','MSN 1325','Airbus', 'A340');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-CMJ','Kam','MSN 2164','Airbu' ,'A330neo');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-FBA','Ray','MSN 6725','Boein', '777');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-IOO','Pra','MSN 4925','Boei', '747');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-IWX','Tri','MSN 3786','Boe', '767');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-JXR','Wow','MSN 2248','Bo', '737');
INSERT INTO "DT_AIRCRAFT" VALUES ('XY-LQZ','Mip','MSN 5831','Airb', 'A350 XWB');


INSERT INTO "DT_PERSONNEL" VALUES (1,'P','NAN');
INSERT INTO "DT_PERSONNEL" VALUES (2,'P','NAN');
INSERT INTO "DT_PERSONNEL" VALUES (3,'M','Prat');
INSERT INTO "DT_PERSONNEL" VALUES (4,'M','Prat');
INSERT INTO "DT_PERSONNEL" VALUES (5,'M','Prat');


INSERT INTO "AIRCRAFT_METRICS" VALUES (1,'XY-ALV',2,8,2,0,1,0,0,0);
INSERT INTO "AIRCRAFT_METRICS" VALUES (2,'XY-CMJ',3,18,1,0,20,20,0,0);
INSERT INTO "AIRCRAFT_METRICS" VALUES (3,'XY-FBA',4,23,1,0,20,50,0,0);


INSERT INTO "FT_LOGS" VALUES (1,'XY-ALV',1,10);
INSERT INTO "FT_LOGS" VALUES (2,'XY-CMJ',2,20);
INSERT INTO "FT_LOGS" VALUES (3,'XY-FBA',3,30);

*/


------ VIEW LOGS

CREATE MATERIALIZED VIEW LOG ON DT_AIRCRAFT
WITH ROWID, SEQUENCE(REGISTRATION_CODE, MANUFACTURER_SERIAL_NMBR, MANUFACTURER, MODEL)
INCLUDING NEW VALUES;

CREATE MATERIALIZED VIEW LOG ON DT_TIME_DAY
WITH ROWID, SEQUENCE(ID_DAY, T_DAY, ID_MONTH)
INCLUDING NEW VALUES;

CREATE MATERIALIZED VIEW LOG ON DT_TIME_MONTH
WITH ROWID, SEQUENCE(ID_MONTH, T_MONTH, ID_YEAR)
INCLUDING NEW VALUES;

CREATE MATERIALIZED VIEW LOG ON DT_TIME_YEAR
WITH ROWID, SEQUENCE(ID_YEAR, T_YEAR)
INCLUDING NEW VALUES;

CREATE MATERIALIZED VIEW LOG ON DT_PERSONNEL
WITH ROWID, SEQUENCE(ID_REPORTEUR, PERSON_ROLE, AIRPORT)
INCLUDING NEW VALUES;


CREATE MATERIALIZED VIEW LOG ON AIRCRAFT_METRICS
WITH ROWID, SEQUENCE(  
	ID_DAY,
  	REGISTRATION_CODE,
  	TAKE_OFF_TO,
  	FLIGHT_HOURS_FH,
  	DELAY_QUANTITY,
 	NUMBER_OF_CANCELLATIONS,
	DAYS_IN_SERVICE_ADIS,
 	DELAY_DURATION,
 	DAYS_OUT_OF_SERVICE_S,
  	DAYS_OUT_OF_SERVICE_U
	)
INCLUDING NEW VALUES;


CREATE MATERIALIZED VIEW LOG ON FT_LOGS
WITH ROWID, SEQUENCE(  
  	REGISTRATION_CODE,
  	ID_REPORTEUR,						
  	ID_MONTH,
    LOGBOOK_COUNT								
	)
INCLUDING NEW VALUES;


---------VIEW CREATION ------------

CREATE MATERIALIZED VIEW MV_AIRCRAFT_INFO
BUILD IMMEDIATE 
REFRESH FAST
ON DEMAND 
ENABLE QUERY REWRITE
AS
SELECT a.REGISTRATION_CODE, a.MODEL, td.T_DAY, tm.T_MONTH, ty.T_YEAR,
	SUM(f.FLIGHT_HOURS_FH) AS FH,
	SUM(f.TAKE_OFF_TO) AS TO_, 
	SUM(f.DAYS_IN_SERVICE_ADIS) as ADIS,
	SUM(f.DAYS_OUT_OF_SERVICE_S) as ADOSS,
	SUM(f.DAYS_OUT_OF_SERVICE_U) AS ADOSU,
	SUM(f.DELAY_QUANTITY) AS DY,
	SUM(NUMBER_OF_CANCELLATIONS) AS CN,
	SUM(DELAY_DURATION) AS DD
FROM DT_AIRCRAFT a, DT_TIME_DAY td, AIRCRAFT_METRICS f, DT_TIME_MONTH tm, DT_TIME_YEAR ty
WHERE f.REGISTRATION_CODE = a.REGISTRATION_CODE
	AND f.ID_DAY = td.ID_DAY AND td.ID_MONTH=tm.ID_MONTH AND tm.ID_MONTH=ty.ID_YEAR
GROUP BY a.REGISTRATION_CODE, a.MODEL, td.T_DAY, tm.T_MONTH, ty.T_YEAR
ORDER BY a.REGISTRATION_CODE, a.MODEL, td.T_DAY, tm.T_MONTH, ty.T_YEAR;


CREATE MATERIALIZED VIEW MV_LOGBOOK
BUILD IMMEDIATE 
REFRESH FAST 
ON DEMAND 
ENABLE QUERY REWRITE
AS
SELECT a.REGISTRATION_CODE, a.MODEL, a.MANUFACTURER_SERIAL_NMBR, tm.T_MONTH, ty.T_YEAR, p.ID_REPORTEUR, p.AIRPORT, p.PERSON_ROLE,
	COUNT (case when p.PERSON_ROLE = 'M' then 1 else null end) as MaintCount,
	COUNT(case when p.PERSON_ROLE = 'P' then 1 else null end) as PilotCount,
	SUM(L.LOGBOOK_COUNT) AS logbook_sum,
	SUM(f.TAKE_OFF_TO) AS takeoffs_sum,
	SUM(f.FLIGHT_HOURS_FH) AS flight_hours_sum
FROM DT_AIRCRAFT a, DT_TIME_MONTH tm, DT_TIME_DAY td, DT_TIME_YEAR ty, DT_PERSONNEL p, FT_LOGS l, AIRCRAFT_METRICS f
WHERE l.REGISTRATION_CODE = a.REGISTRATION_CODE
	AND td.ID_DAY=f.ID_DAY
	AND l.ID_MONTH = tm.T_MONTH
	AND tm.ID_YEAR = ty.ID_YEAR
	AND p.ID_REPORTEUR = l.ID_REPORTEUR
	AND l.REGISTRATION_CODE = f.REGISTRATION_CODE
	AND td.ID_MONTH=tm.ID_MONTH
GROUP BY a.REGISTRATION_CODE, a.MODEL, a.MANUFACTURER_SERIAL_NMBR, tm.T_MONTH, ty.T_YEAR, p.ID_REPORTEUR, p.AIRPORT, p.PERSON_ROLE
ORDER BY a.REGISTRATION_CODE, a.MODEL, a.MANUFACTURER_SERIAL_NMBR, tm.T_MONTH, ty.T_YEAR, p.ID_REPORTEUR, p.AIRPORT, p.PERSON_ROLE;

----------------------------------------------------QUERIES------------------------------------------------------------------


/*
a)
SELECT FH, TO_, REGISTRATION_CODE, MODEL, T_DAY, T_MONTH, T_YEAR
FROM MV_AIRCRAFT_INFO;


b)	
SELECT ADIS,ADOSS, ADOSU, (ADOSS+ADOSU) AS ADOS, (DY/TO_) AS DYR, (CN/TO_) AS CNR, (100-((DY+CN)/TO_)*100) AS TDR, (DD/DY)*100 AS ADD_, MODEL, T_DAY, T_MONTH, T_YEAR
FROM MV_AIRCRAFT_INFO;

c)	
SELECT 1000*(logbook_sum/flight_hours_sum) AS RRh, 100*(logbook_sum/takeoffs_sum) AS RRc, CAST((1000*(((PilotCount/(PilotCount+MaintCount))*logbook_sum)/flight_hours_sum))AS INTEGER) AS PRRh,
	CAST((100*(((PilotCount/(PilotCount+MaintCount))*logbook_sum)/takeoffs_sum))AS INTEGER) AS PRRc, CAST((1000*(((MaintCount/(PilotCount+MaintCount))*logbook_sum)/flight_hours_sum))AS INTEGER) AS MRRh,
	CAST((100*(((MaintCount/(PilotCount+MaintCount))*logbook_sum)/takeoffs_sum))AS INTEGER) AS MRRc, MODEL, MANUFACTURER_SERIAL_NMBR, T_MONTH, T_YEAR 
FROM MV_LOGBOOK;

d)
SELECT CAST((1000*(((MaintCount/(PilotCount+MaintCount))*logbook_sum)/flight_hours_sum))AS INTEGER) AS MRRh,
	CAST((100*(((MaintCount/(PilotCount+MaintCount))*logbook_sum)/takeoffs_sum))AS INTEGER) AS MRRc, AIRPORT, MODEL
FROM MV_LOGBOOK;

*/


--------------------DROP------------------------------------------

/*
DROP TABLE "DT_TIME" CASCADE CONSTRAINTS;
DROP TABLE "DT_TIME_DAY" CASCADE CONSTRAINTS;
DROP TABLE "DT_AIRCRAFT" CASCADE CONSTRAINTS;
DROP TABLE "DT_PERSONNEL" CASCADE CONSTRAINTS;
DROP TABLE "AIRCRAFT_METRICS" CASCADE CONSTRAINTS;
DROP TABLE "FT_LOGS" CASCADE CONSTRAINTS;
DROP MATERIALIZED VIEW MV_LOGBOOK;
DROP MATERIALIZED VIEW MV_AIRCRAFT_INFO;
*/


